#!/bin/bash
# Функция, реализующая бесконечный цикл тяжелых вычислений.
# Здесь просто перемножается два числа в цикле.
heavy_calc() {
  a=1
  b=2
  while true; do
    a=$((a * b))
    # Чтобы избежать переполнения, сбрасываем a, если оно становится слишком большим.
    [ $a -gt 1000000 ] && a=1
  done
}

# Запускаем три фоновых процесса
heavy_calc &
pid1=$!
heavy_calc &
pid2=$!
heavy_calc &
pid3=$!

echo "Запущены процессы:"
echo "PID1 = $pid1"
echo "PID2 = $pid2"
echo "PID3 = $pid3"

# Для контроля использования CPU первым процессом используем утилиту cpulimit.
# Ограничиваем процесс с pid1 до 10% CPU.
cpulimit -p $pid1 -l 10 &
echo "Применён лимит CPU к процессу $pid1 (не более 10%)."

# Ждём некоторое время, чтобы процессы стабилизировались.
sleep 10

# Завершаем работу третьего процесса, посылая ему SIGTERM.
kill -TERM $pid3
echo "Послан сигнал SIGTERM для завершения процесса $pid3."

# Мониторим использование CPU первого процесса.
echo "Мониторинг использования CPU процесса $pid1 (обновление каждые 5 секунд):"
while true; do
  cpu=$(ps -p $pid1 -o %cpu --no-headers | awk '{print int($1)}')
  echo "Процесс $pid1: $cpu% CPU"
  sleep 5
done
# с помощью команды top можно также визуально проверить, что процесс с PID1 не превышает 10% использования CPU, а процесс с PID3 завершён.
